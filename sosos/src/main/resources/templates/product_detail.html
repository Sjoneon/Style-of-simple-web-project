<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 상세 페이지</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f9f9f9;
            margin: 0;
        }

        .product-container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .product-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .product-header img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
        }

        .product-info {
            text-align: center;
        }

        .product-info h1 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .product-info .price {
            font-size: 1.5em;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
        }

        .product-info .stock-status {
            font-size: 1em;
            color: #888;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .buttons button {
            font-size: 1em;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

        .buttons button.buy-now {
            background-color: #333;
            color: white;
        }

        .buttons button.buy-now:disabled {
            background-color: #bbb;
            cursor: not-allowed;
        }

        .buttons button.add-to-cart {
            background-color: white;
            border: 1px solid #ddd;
        }

        .product-description {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .product-description h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .product-description-content {
            line-height: 1.6;
            color: #555;
        }

        .product-description-content img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            display: block;
        }
    </style>
    <script>
        // 상품 정보 로드
        async function loadProduct() {
            const productId = new URLSearchParams(window.location.search).get('id');
            
            try {
                const response = await fetch(`/api/products/${productId}`);
                if (!response.ok) {
                    throw new Error('상품 데이터를 불러오지 못했습니다.');
                }
                
                const product = await response.json();
                
                // 상품 정보 표시
                document.querySelector('.product-image').src = product.imageUrl || '/images/no-image.png'; // 기본 이미지 처리
                document.querySelector('.product-name').textContent = product.name;
                document.querySelector('.product-price').textContent = `${product.price.toLocaleString()}원`;
                document.querySelector('.stock-status').textContent = product.quantity > 0 ? `재고: ${product.quantity}개` : '재고 없음';
    
                // 구매 버튼 상태 업데이트
                const buyNowButton = document.querySelector('.buy-now');
                buyNowButton.disabled = product.quantity <= 0;
    
                // 장바구니 버튼에 이벤트 연결
                const addToCartButton = document.querySelector('.add-to-cart');
                addToCartButton.addEventListener('click', () => addToCart(productId));
    
                // 상품 상세 설명 처리
                const descriptionContent = document.querySelector('.product-description-content');
                descriptionContent.innerHTML = ''; // 기존 내용 초기화
    
                if (product.description) {
                    descriptionContent.innerHTML += `<p>${product.description}</p>`;
                }
                if (product.descriptionImageUrl) {
                    descriptionContent.innerHTML += `<img src="${product.descriptionImageUrl}" alt="상세 설명 이미지">`;
                }
    
                // 둘 다 없을 경우
                if (!product.description && !product.descriptionImageUrl) {
                    descriptionContent.textContent = '상세 설명이 없습니다.';
                }
            } catch (error) {
                alert(error.message);
                document.querySelector('.product-container').innerHTML = '<p>상품 정보를 불러오지 못했습니다.</p>';
            }
        }
    
        // 장바구니에 상품 추가 처리
        async function addToCart(productId) {
    try {
        const response = await fetch(`/api/products/cart/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: 1, // 기본 수량 1
            }),
        });

        if (response.ok) {
            alert('상품이 장바구니에 추가되었습니다.');
        } else {
            const errorData = await response.json();
            alert(`장바구니 추가 실패: ${errorData.message || '알 수 없는 오류가 발생했습니다.'}`);
        }
    } catch (error) {
        alert('장바구니 추가 요청 중 오류가 발생했습니다.');
    }
}

    
        // 즉시 구매 처리
        async function purchaseProduct() {
            const productId = new URLSearchParams(window.location.search).get('id');
            try {
                const response = await fetch(`/api/orders/purchase?productId=${productId}`, {
                    method: 'POST'
                });
    
                if (response.ok) {
                    alert("구매가 완료되었습니다.");
                    loadProduct(); // 구매 후 재고 업데이트를 위해 상품 정보 다시 로드
                } else {
                    const errorData = await response.json();
                    alert(`구매 실패: ${errorData.message || '알 수 없는 오류가 발생했습니다.'}`);
                }
            } catch (error) {
                alert("구매 요청 중 오류가 발생했습니다.");
            }
        }
    
        // 페이지 로드 시 상품 정보 로드
        document.addEventListener('DOMContentLoaded', loadProduct);
    </script>    
</head>
<body>
    <div class="product-container">
        <!-- 상품 이미지 및 정보 -->
        <div class="product-header">
            <img class="product-image" alt="상품 이미지">
        </div>
        <div class="product-info">
            <h1 class="product-name"></h1>
            <p class="price product-price"></p>
            <p class="stock-status"></p>
            <div class="buttons">
                <button class="buy-now" onclick="purchaseProduct()">즉시 구매</button>
                <button class="add-to-cart">장바구니 담기</button>
            </div>
        </div>

        <!-- 상품 상세 설명 -->
        <div class="product-description">
            <h2>상품 상세 설명</h2>
            <div class="product-description-content"></div>
        </div>
    </div>
</body>
</html>
